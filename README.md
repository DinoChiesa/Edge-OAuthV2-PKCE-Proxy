# OAuth Token-granting Proxy for 3-legged (Authorization code) flow with PKCE

This is an API Proxy that implements the OAuth2.0 3-legged (authorization code) flow, with PKCE ([RFC 7636](https://tools.ietf.org/html/rfc7636)).
The login-and-consent app is bundled with the API Proxy.
This makes it super easy to demonstrate 3-legged OAuthV2 with PKCE in Apigee Edge.

## Setup

You need an API Product, a developer, and a developer app, with its client_id and client_secret.
The API Product should have scopes: A,B,C
The app should have a redirect_uri of https://dinochiesa.github.io/pkce-redirect/callback-handler.html

## To Kick off the flow:

```
ORG=myorg
ENV=myenv
curl -i -X GET "https://$ORG-$ENV.apigee.net/20181127/oauth2-ac-pkce/authorize?client_id=${client_id}&redirect_uri=${redirect_uri}&response_type=code&scope=A&code_challenge=XXX&code_challenge_method=S256"
```

Breaking that request down, here are the query params.

| param                 | description                                                              |
| --------------------- | ------------------------------------------------------------------------ |
| client_id             | a registered client id within Apigee Edge                                |
| redirect_uri          | a valid uri registered for the API Product authorized by that client ID. |
| response_type         | always `code` in this example, for authorization code grant.             |
| scope                 | a space-separated list of scopes allowed by this API Product.            |
| code_challenge        | the [code challenge](https://tools.ietf.org/html/rfc7636#section-4.1) as described by RFC 7636. |
| code_challenge_method | the code challenge method. For calls to this proxy, must always have the value S256.            |


Invoking the URL for the /authorize request will redirect you to a URL for the login-and-consent app.  You need to open the resulting link in a browser and authenticate.

The login-and-consent app uses a mock user database, and these are the valid username / password pairs:
* dino@apigee.com / IloveAPIs
* valerie@example.com / Wizard123
* heidi@example.com / 1Performance
* greg@example.com / Memento4Quiet
* naimish@example.com / Imagine4


Once you authenticate and grant consent, you will receive a code via the redirect_uri.
The redirect_uri you pass should be able to display a code. The one shown above works just fine for most purposes.

## To exchange the code and verifier for a token:

Copy the code shown in the redirect_uri web page, then paste it into a request like so:

```
curl -i -X POST "https://$ORG-$ENV.apigee.net/20181127/oauth2-ac-pkce/token" \
   -u ${client_id}:${client_secret} \
   -d 'grant_type=authorization_code&code=${authorization_code}&code_verifier=XXXX'
```

If the code is invalid, or if the code verifier does not match the challenge you used to obtain the code,
the token request will return 401.

## Code Verifier and Challenge

The verifier is a string of random characters, from 43 to 128 characters in length. Why? I don't know, that's what the spec says.

The challenge is BASE64URL(SHA256(code_verifier)).
In other words it is a shorter string representing the SHA256 of the verifier.

The two strings are different. It is possible to compute the challenge from the verifier. It is not possible to compute the verifier from the challenge.

In the /authorize call, the client passes the CHALLENGE.
When exchanging the code for a token, the client passes the VERIFIER.


## Helper

There is [a helper page](https://dinochiesa.github.io/pkce-redirect/pkce-link-builder.html) to assist you in building the /authorize URL.

Nothing like the helper will ever be seen by a real user. This is just a development-time tool, useful for demonstrating and exercising the flow. Once a real app is built, it embeds the URL that might be generated by the helper, into its own code.

Also, when the proxy returns the code, you can return to the helper page and
paste in the code in the appropriate box.  The helper page will generate the
CURL request that allows you to redeem the code for a token.  Paste in the code
and press TAB to get the URL to appear. 


## Disclaimer

This example is not an official Google product, nor is it part of an official Google product.

## Support

This example is just an illustration. It is not a supported part of Apigee Edge.
If you need assistance, you can try inquiring on
[The Apigee Community Site](https://community.apigee.com).  There is no service-level
guarantee for responses to inquiries regarding this proxy.

## License

This material is copyright 2018 Google LLC.
and is licensed under the [Apache 2.0 License](LICENSE).

## Bugs

* The /token request is not CORS compliant, so redeeming the code for a token from the helper page does not work.
  (Must use curl).

